@page
@model IndexModel
@{
    ViewData["Title"] = "Demande d'aide financière de dernier recours";
    ViewData["masquerPremierEspaceurConteneurColonnes"] = true;
}

@section style{
    <link rel="stylesheet" href="form/snow.min.css">
    <style>
        @@media (min-width: 650px) {
            .order {
                display: flex;
            }
        }

        @@media (min-width: 720px) {
            .order {
                display: block;
            }
        }

        @@media (min-width: 850px) {
            .order {
                display: flex;
            }

                .order .formulate-input {
                    margin-right: 1.5em;
                }
        }

        .order .formulate-input {
            margin-right: 2em;
            margin-bottom: 0;
        }

        .flex-wrapper {
            max-width: 20em;
            display: flex
        }

            .flex-wrapper > .formulate-input:nth-child(odd) {
                margin-right: 1em;
            }

            .flex-wrapper > .formulate-input.flex-item-small {
                width: 5em;
                flex-basis: 5em;
                flex-shrink: 0;
            }

            .flex-wrapper > .formulate-input {
                flex-grow: 1;
            }


        .formulate-input[data-classification=text] .formulate-input-element--date input {
            padding: .60em;
        }
    </style>
}
@section colonneGauche{
    <div id="form">
        @*<template>
                <formulate-form v-model="values"
                                :schema="schema"></formulate-form>
            </template>*@


        <template>
            @Html.Raw(Model.Formulaire)
        </template>
    </div>
}

@section colonneDroite{

}

@section scripts{
    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="form/formulate.min.js"></script>
    <script src="form/locales.min.js"></script>
    <script src="form/mtess-vueformulate.min.js"></script>

    <script>
    Vue.component('Label', MtessVueformulate.Label)
    Vue.component('ErrorList', MtessVueformulate.ErrorList)
    Vue.component('RepeatableRemove', MtessVueformulate.RepeatableRemove)

    Vue.use(VueFormulate, {
        plugins: [this.VueFormulateI18n.fr],
        slotComponents: {
            label: 'Label',
            errorList: 'ErrorList',
            remove: 'RepeatableRemove'
        },
        locale: 'fr',
        validationNameStrategy: ['validationName', 'label', 'name', 'type']
    });

    const App = {
        el: '#form',
        methods: {
            failedValidation(data) {
                this.$el.setAttribute('data-submit', true)
                console.log('failedValidation')
                // console.log(data)
            },
            submitHandler(data) {
                axios.post('/Privacy', data)
            },
            invalidMessage(fields) {
                console.log('invalidMessage')
                const listeErreurs = []
                const nomChamps = Object.keys(fields)

                nomChamps.forEach(nomChamp => {
                    const champ = fields[nomChamp]
                    if (champ.hasVisibleErrors) {
                        if (champ.context && champ.context.type !== 'group') {
                            this.ajouterErreursChamp(champ, listeErreurs)
                        } else {
                            this.ajouterErreursGroupe(champ, listeErreurs)
                        }
                    }
                })
                return JSON.stringify(listeErreurs)
            },
            ajouterErreursChamp(champ, listeErreurs) {
                champ.context.visibleValidationErrors.forEach(message => {
                    listeErreurs.push({ id: champ.context.id, message: message })
                })
            },
            ajouterErreursGroupe(groupe, listeErreurs) {
                const conteneursChamps = groupe.$el.querySelectorAll('.formulate-input')

                conteneursChamps.forEach(conteneurChamp => {
                    if (conteneurChamp.hasAttribute('data-is-showing-errors')) {
                        const label = conteneurChamp.querySelector('label')
                        const messages = conteneurChamp.querySelectorAll('.formulate-input-error')

                        if (label && messages.length > 0) {
                            const id = label.getAttribute('for')

                            messages.forEach(message => {
                                listeErreurs.push({ id: id, message: message.innerText })
                            })
                        }
                    }
                })
            }
        },
        data: {
            contenuform: {},
            formErrors: [],
            inputErrors: {}
        },
       @*/* data: {
            values: {},
            schema: @Html.Raw(Model.Formulaire)
        },
        */*@
        mounted() {
            console.log('Application mounted.')
        }
    }

    window.addEventListener('load', () => {
        new Vue(App)
    })

        </script>
    }